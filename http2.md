上篇聊了HTTP/1.1的发展历程、问题以及改进，但就目前来说依然存在一些性能瓶颈。这篇依然先聊HTTP/1.1存在的问题，再分析HTTP/2.0是如何解决这些问题的
##HTTP/1.1主要的问题

####1. TCP连接数量限制
为了避免一次性建立大量TCP连接，浏览器限制每个域名最多维护6个TCP连接，但是现代网站基本都会有几十上百的资源需要加载，这就大大降低了资源加载效率。因此很多网站就把资源放在不同域名的CDN上，用**域名分片机制**来做优化。

![](https://pic.imgdb.cn/item/60ced179844ef46bb28b0664.jpg)

对于有大量资源的网站，域名分片可以对整体的加载速度有极大地提升。但是极大部分网站是没有使用这种优化方案的

####2. 带宽利用率低
为什么说HTTP/1.1对宽带的利用率低呢，比如100M的宽带每秒的下行速率为12.5M，使用HTTP/1.1的时候很难将带宽拉满，估计也就能利用3-5M。之所以出现这个问题，主要就是因为下面几个原因导致

- **TCP慢启动**
最初的TCP在连接建立成功后会向网络中发送大量的数据包，这样很容易导致网络中路由器缓存空间耗尽，从而发生拥塞。因此**新建立的连接不能够一开始就大量发送数据包，而只能根据网络情况逐步增加每次发送的数据量**，以避免上述现象的发生
数据量是以指数级增长的
开始 ---> cwnd（最大报文段） = 1
经过1个RTT后 ---> cwnd = 2\*1 = 2
经过2个RTT后 ---> cwnd = 2\*2= 4
经过3个RTT后 ---> cwnd = 4\*2 = 8
为了避免无限制增长，当达到某一阀值的时候就会把指数增加改为加法增加
可以看到慢启动其实也并不慢，但是放到网页中来看的话就会发现，网页中的资源一般都很小，很快就加载完成。所以慢启动所耗费的时间相对来说就很多。这样对页面的首次渲染就带来的很大的影响

- **多个TCP链接会竞争固定的带宽**
浏览器同时建立多个TCP链接，当带宽充足的时候还好，但是当带宽不足的时，这些链接会同时减慢数据的传输。
这样就会出现一个问题，当多个资源存在优先级的时候，比如重要的js、css,不重要的图片、音视频等，这时多个TCP链接之间是无法协商让哪些资源优先下载的。这样就会影响重要资源的下载速度，从而影响页面的体验

- **队头阻塞问题**
HTTP/1.1虽然增加了长链接，多个请求可以公用一个TCP链接，但是同一时刻只能传输一个请求，当前请求没有传输完成之前，下一个请求只能处于阻塞状态
这是一个很严重的问题，因为请求阻塞的原因有很多，网络、路由、服务器都有可能导致。假如其中一个请求被某种原因阻塞了5s，那后面的请求只能等待，此时宽带、CPU都被白白浪费。所以队头阻塞以及不能并请请求是非常不利于性能优化的

##HTTP/2.0
针对上面的问题HTTP/2.0又是如何改进优化的呢

####多路复用
因为软硬件对TCP协议的支持是非常成熟的，就目前而言还是无法把TCP协议替换掉，所以HTTP/2.0采用的依然是TCP。
基于此，**HTTP/2 的思路就是一个域名只使用一个 TCP 长连接来传输数据**，这样多个资源的下载只需要一次慢启动，同时也避免了多个连接竞争资源的问题
另外队头阻塞的问题，HTTP/2.0实现资源的并行求情来解决，而且服务器还能主动对资源进行推送。

![](https://pic.imgdb.cn/item/60cee42b844ef46bb22e00ac.jpg)

该图就是 HTTP/2 最核心、最重要且最具颠覆性的**多路复用机制**。图中的每个请求都有一个对应的 ID，这样不管在浏览器还是服务端HTTP/2都能再根据ID重新把数据组装。多路复用是怎么实现的呢，我们看下图

![](https://pic.imgdb.cn/item/60cefcf2844ef46bb206698d.jpg)

从图中可以看出，HTTP/2 添加了一个二进制分帧层
- 首先，浏览器准备好请求数据，包括请求行、请求头、请求体等
- 这些数据经过二进制分帧层处理，被转换为一个个带有请求 ID 编号的帧并发送给服务器
- 服务器接收到所有帧之后，会将所有相同 ID 的帧合并为一条完整的请求
- 然后服务器处理该条请求，并将处理的响应行、响应头和响应体给二进制分帧层
- 二进制分帧层再将这些响应数据转换为一个个带有请求 ID 编号的帧，送给浏览器
- 浏览器接收到响应帧之后，会根据 ID 编号将帧合并为数据返回给对应的请求

![](https://pic.imgdb.cn/item/60cefb9b844ef46bb2fba300.jpg)

以上我可以看到HTTP/2.0只是增加了一层，并不影响原先的语义，比如头信息里的Accept、cookie、Cache等字段信息，这一点非常重要。这意味着我们不需要为 HTTP/2 去重建生态，使 HTTP/2 的推广更轻松

####其他特性
**1. 请求的优先级**
HTTP/2 提供了请求优先级，可以在发送请求时，标上该请求的优先级，这样服务器接收到请求之后，会优先处理优先级高的请求
比如对优先级较高的index.html、js、css等先进行处理，图片、音视频等优先级低的后处理
**2. 服务器推送**
HTTP/2 可以直接将数据提前推送到浏览器。比如这样一个场景，当浏览器请求一个index.html之后，服务器在接收到请求之后知道该页面会引用几个重要的 js 文件和 css 文件，那么在返回index.html的时候附带将 js 和 css 文件一并返回给浏览器，这样当浏览器解析完 HTML 文件之后，就能直接拿到需要的 css 和 js 文件，这将使首次打开页面的速度得到很大的提升
**3. 头部压缩**
无论是 HTTP/1.1 还是 HTTP/2，它们都有请求头和响应头，这是浏览器和服务器的通信语言。HTTP/2 对请求头和响应头进行了压缩，通常情况下页面也有 100 个左右的资源，如果将这 100 个请求头的数据压缩为原来的 20%，那么传输效率肯定能得到大幅提升。
而且浏览器和服务端还各自cache一份header fields表，既避免了重复header的传输，又减小了需要传输的大小

##最后

HTTP/2 协议规范于 2015 年正式发布，之后得到了很快的发展。目前国内外一些比较大的的站点基本都实现了 HTTP/2 的部署。使用 HTTP/2 能带来 20%～60% 的效率提升，至于 20% 还是 60% 要看优化的程度。总之，我们也应该与时俱进，去“拥抱”HTTP/2

虽然HTTP/2.0解决了HTTP应用层的队头阻塞问题，但是传输层TCP数据包级别的队头阻塞依然存在且无法解决。如果想要解决就要寻求其他传输层协议，HTTP/3.0就是这么做的，下篇我们再看下HTTP/3.0是怎么解决这个问题的




